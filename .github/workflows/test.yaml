name: Create Multi-Architecture Manifest
on:
  workflow_dispatch:
    inputs:
      amd64_tag:
        description: 'Image tag AMD64 (sin el prefijo leonhrt/dev-images-hub:)'
        required: true
        default: 'agent-test-amd64-c1da890df23b20fe6a75850e4655d6bf0d93c514'
      arm64_tag:
        description: 'Image tag ARM64 (sin el prefijo leonhrt/dev-images-hub:)'
        required: true
        default: 'agent-test-arm64-c1da890df23b20fe6a75850e4655d6bf0d93c514'
      output_tag:
        description: 'Image tag multi-arch'
        required: true
        default: 'agent-test-k3s'

jobs:
  create-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Install latest Docker CLI
        run: |
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          docker version
      
      - name: Inspect source images
        run: |
          echo "Inspecting image AMD64..."
          docker manifest inspect leonhrt/dev-images-hub:${{ github.event.inputs.amd64_tag }} || echo "Couldn't inspect image AMD64"
          
          echo "Inspeccionando imagen ARM64..."
          docker manifest inspect leonhrt/dev-images-hub:${{ github.event.inputs.arm64_tag }} || echo "Couldn't inspect image ARM64"
      
      - name: Pull images to verify they exist
        run: |
          docker pull leonhrt/dev-images-hub:${{ github.event.inputs.amd64_tag }} || echo "Couldn't pull image AMD64"
          docker pull leonhrt/dev-images-hub:${{ github.event.inputs.arm64_tag }} || echo "Couldn't pull image ARM64"
          
          docker images
      
      - name: Create manifest using buildx imagetools
        run: |
          docker manifest rm leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }} || true
          
          docker buildx imagetools create \
            --tag leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.amd64_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.arm64_tag }}
          
          echo "Verifying new manifest..."
          docker manifest inspect leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }}
      
      - name: Fallback to classical manifest method
        if: failure()
        run: |
          echo "buildx imagetools method failed, trying with docker manifest..."
          
          docker manifest create leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.amd64_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.arm64_tag }}
          
          docker manifest annotate --arch amd64 leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.amd64_tag }}
          docker manifest annotate --arch arm64 leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }} \
            leonhrt/dev-images-hub:${{ github.event.inputs.arm64_tag }}
          
          docker manifest push leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }}
          
          echo "Verifying new manifest..."
          docker manifest inspect leonhrt/dev-images-hub:${{ github.event.inputs.output_tag }}
