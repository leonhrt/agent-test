version: 2.1

orbs:
  docker: circleci/docker@2.2.0

parameters:
  image-name:
    type: string
    default: "leonhrt/dev-images-hub"
  image-tag:
    type: string
    default: "${CIRCLE_SHA1:0:7}"

executors:
  amd64-executor:
    docker:
      - image: cimg/base:2023.03
    resource_class: medium
  arm64-executor:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium

jobs:
  build-and-push-amd64:
    executor: amd64-executor
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Login to Docker Hub
          command: echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
      - run:
          name: Build AMD64 image
          command: |
            docker build --platform=linux/amd64 -t << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-amd64 .
      - run:
          name: Push AMD64 image
          command: |
            docker push << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-amd64

  build-and-push-arm64:
    executor: arm64-executor
    steps:
      - checkout
      - run:
          name: Login to Docker Hub
          command: echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
      - run:
          name: Build ARM64 image
          command: |
            docker build --platform=linux/arm64 -t << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-arm64 .
      - run:
          name: Push ARM64 image
          command: |
            docker push << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-arm64

  create-manifest-and-push:
    executor: amd64-executor
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install Docker CLI plugins for buildx
          command: |
            mkdir -p ~/.docker/cli-plugins
            curl -L -o ~/.docker/cli-plugins/docker-buildx https://github.com/docker/buildx/releases/download/v0.10.4/buildx-v0.10.4.linux-amd64
            chmod +x ~/.docker/cli-plugins/docker-buildx
            docker buildx version
      - run:
          name: Login to Docker Hub
          command: echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
      - run:
          name: Create and push multi-architecture manifest
          command: |
            # Create the manifest
            docker buildx imagetools create \
              --tag << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >> \
              --tag << pipeline.parameters.image-name >>:latest \
              << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-amd64 \
              << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>-arm64
            
            # Verify the manifest
            docker buildx imagetools inspect << pipeline.parameters.image-name >>:<< pipeline.parameters.image-tag >>

workflows:
  version: 2
  build-multiarch-image:
    jobs:
      - build-and-push-amd64:
          context:
            - dockerhub-credentials
      - build-and-push-arm64:
          context:
            - dockerhub-credentials
      - create-manifest-and-push:
          requires:
            - build-and-push-amd64
            - build-and-push-arm64
          context:
            - dockerhub-credentials
          filters:
            branches:
              only: main
